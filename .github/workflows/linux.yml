name: Linux

on:
  push:
    branches: [ main ]
  pull_request:

env:
  OPENSSL_VERSION: 3.0.1
  BOOST_VERSION: 1.78.0

jobs:
  x86_64-unknown-linux-gnu:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        build_type: [ Debug, Release ]
        coverage: [ off ]
        compiler:
          - cc: clang-12
            cxx: clang++-12
            subpackage: lld-12
          - cc: clang-13
            cxx: clang++-13
            subpackage: lld-13
          - cc: clang-14
            cxx: clang++-14
            subpackage: lld-14
          - cc: gcc-11
            cxx: g++-11
            subpackage: binutils
          - cc: gcc-12
            cxx: g++-12
            subpackage: binutils
        include:
          - build_type: Debug
            coverage: on
            compiler:
              cc: gcc-12
              cxx: g++-12
              subpackage: binutils
    env:
      CC: ${{ matrix.compiler.cc }}
      CXX: ${{ matrix.compiler.cxx }}
      CACHE_KEY_PREFIX: v3-${{ github.ref }}-${{ github.job }}-${{ matrix.compiler.cc }}-${{ matrix.build_type }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup GCC
        if: startsWith(matrix.compiler.cc, 'gcc')
        run: sudo apt-get install -y -qq ${{ matrix.compiler.cxx }}

      - name: Setup Clang
        if: startsWith(matrix.compiler.cc, 'clang')
        run: sudo apt-get install -y -qq ${{ matrix.compiler.cc }}

      - name: Install Ninja & ${{ matrix.compiler.subpackage }}
        run: |
          sudo apt-get -qq clean
          sudo apt-get -qq update
          sudo apt-get install -y -qq ninja-build ${{ matrix.compiler.subpackage }}

      - name: Restore & Cache CMake build results
        if: matrix.coverage != 'on'
        uses: actions/cache@v3.0.2
        with:
          path: build
          key: ${{ env.CACHE_KEY_PREFIX }}-${{ hashFiles('CMakeLists.txt', 'cmake/*.cmake') }}

      - name: Install openssl
        if: startsWith(matrix.compiler.cc, 'clang')
        run: sudo apt-get install -y -qq libssl-dev

      - name: Restore & Cache openssl (${{ env.OPENSSL_VERSION }})
        if: startsWith(matrix.compiler.cc, 'gcc')
        uses: actions/cache@v3.0.2
        id: openssl-cache
        with:
          path: ${{ runner.temp }}/libs/openssl
          key: ${{ env.CACHE_KEY_PREFIX }}-openssl-${{ env.OPENSSL_VERSION }}
      - name: Install openssl (${{ env.OPENSSL_VERSION }}) as static
        if: startsWith(matrix.compiler.cc, 'gcc') && steps.openssl-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ${{ runner.temp }}/libs/openssl
          git clone -q -b openssl-${{ env.OPENSSL_VERSION }} https://github.com/openssl/openssl.git
          cd openssl
          ./config --static -static --prefix=${{ runner.temp }}/libs/openssl
          make
          sudo make install
          echo "OPENSSL_ROOT_DIR=${{ runner.temp }}/libs/openssl" >> "$GITHUB_ENV"
        working-directory: ${{ runner.temp }}

      - name: Restore & Cache boost (${{ env.BOOST_VERSION }})
        uses: actions/cache@v3.0.2
        id: boost-cache
        with:
          path: ${{ runner.temp }}/libs/boost
          key: ${{ env.CACHE_KEY_PREFIX }}-boost-${{ env.BOOST_VERSION }}
      - name: Install boost (${{ env.BOOST_VERSION }}) as static
        if: steps.boost-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ${{ runner.temp }}/libs/boost
          git clone -q -b boost-${{ env.BOOST_VERSION }} --recursive https://github.com/boostorg/boost.git
          cd boost
          ./bootstrap.sh
          sudo ./b2 link=static install -j2 --prefix=${{ runner.temp }}/libs/boost || exit 0
        working-directory: ${{ runner.temp }}

      - run: mkdir build

      - name: Build Poac
        run: |
          cmake ..                                        \
            -G Ninja                                      \
            -DPOAC_BUILD_TESTING=ON                       \
            -DPOAC_ENABLE_COVERAGE=${{ matrix.coverage }} \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}   \
            -DPOAC_DEPS_DIR=${{ runner.temp }}/libs
          ninja
        working-directory: build

      - name: Test Poac
        run: ctest --output-on-failure --verbose
        working-directory: build

      - name: Running test
        run: ./poac --help
        working-directory: build

      - name: Print info of the executable file
        run: file ./poac
        working-directory: build

      - name: Upload pre-built binary
        uses: actions/upload-artifact@v3
        if: matrix.build_type == 'Release'
        with:
          name: ${{ github.job }}-${{ matrix.compiler.cc }}
          path: ./build/poac

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3.1.0
        if: success() && matrix.coverage == 'on'
